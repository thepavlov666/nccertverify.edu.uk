<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Newcastle College Logo (Code)</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: white;
    }
    .logo {
      text-align: center;
      font-family: Arial, sans-serif;
      color: #0056A4;
    }
    .logo-text {
      font-size: 24px;
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="logo">
    <svg width="200" height="120" viewBox="0 0 200 120" xmlns="http://www.w3.org/2000/svg">
      <!-- Arch -->
      <path d="M 20 100 A 80 80 0 0 1 180 100" stroke="#0056A4" stroke-width="6" fill="none"/>

      <!-- Vertical bars under arch -->
      <line x1="50" y1="100" x2="50" y2="55" stroke="#0056A4" stroke-width="4"/>
      <line x1="75" y1="100" x2="75" y2="40" stroke="#0056A4" stroke-width="4"/>
      <line x1="100" y1="100" x2="100" y2="30" stroke="#0056A4" stroke-width="4"/>
      <line x1="125" y1="100" x2="125" y2="40" stroke="#0056A4" stroke-width="4"/>
      <line x1="150" y1="100" x2="150" y2="55" stroke="#0056A4" stroke-width="4"/>
    </svg>
    <div class="logo-text">Newcastle College</div>
  </div>
  <title>Certificate Verification - Newcastle College Ltd</title>
  <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/UK_flag_icon.svg/1024px-UK_flag_icon.svg.png" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    :root{--brand:#003366;--accent:#00509e}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;background:#f5f9ff;color:#012f6b;min-height:100vh;display:flex;flex-direction:column}
    header{background:var(--brand);color:#fff;padding:1rem 1.5rem;text-align:center}
    header img{height:44px;vertical-align:middle}
    header h1{display:inline-block;margin:0 0 0 .75rem;font-size:1.25rem;font-weight:600;vertical-align:middle}
    main{max-width:760px;margin:2rem auto;padding:2rem;background:#fff;border-radius:10px;box-shadow:0 8px 24px rgba(2,17,55,.06)}
    h2{color:var(--brand);margin-top:0}
    p.intro{color:#234;opacity:.9}
    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:1rem 0}
    button, input, select{font:inherit}
    input[type=text]{width:100%;padding:.7rem;border:1.5px solid var(--brand);border-radius:8px}
    button.primary{background:var(--brand);color:#fff;border:none;padding:.9rem 1rem;border-radius:8px;cursor:pointer;font-weight:700}
    button.ghost{background:#fff;border:1px solid #d5dff7;color:var(--brand);padding:.6rem 1rem;border-radius:8px;cursor:pointer}
    #reader{display:none;margin:1rem auto;max-width:420px;border:3px solid var(--accent);border-radius:12px;overflow:hidden;aspect-ratio:1/1;background:#000}
    #result{margin-top:1rem}
    .verified{background:#e6f9ec;border:1px solid #2e7d32;color:#1f5f2f;padding:1rem;border-radius:8px}
    .not-found{background:#fff1f1;border:1px solid #c62828;color:#8a1e1e;padding:1rem;border-radius:8px}
    .info-small{font-size:.85rem;color:#556;margin-top:1rem}
    footer{background:#012f6b;color:#fff;padding:.9rem;text-align:center;margin-top:2rem}
    #admin-panel{display:none;margin-top:1.5rem;padding:1rem;border-radius:10px;border:2px dashed #dbe8ff;background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:.75rem}
    th,td{padding:.5rem;border:1px solid #e6eef8;text-align:left;font-size:.95rem}
    th{background:#f3f8ff}
    .small{font-size:.9rem}
    .flex{display:flex;gap:.5rem;align-items:center}
    .qr-preview img{max-width:160px;border-radius:8px;border:1px solid #e6eef8}
    a.primary-download{display:inline-block;padding:.45rem .7rem;background:var(--brand);color:#fff;border-radius:6px;text-decoration:none}
  </style>

  <!-- Libraries -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
</head>
<body>
  <header>
    <img src="https://www.newcastlecollege.ac.uk/wp-content/themes/ncl/dist/images/logo.svg" alt="Newcastle College Logo" />
    <h1>Certificate Verification</h1>
  </header>

  <main>
    <h2>Verify Your Qualification</h2>
    <p class="intro">Scan a certificate QR or enter the Qualification Number and Candidate Name to verify a record issued by Newcastle College Ltd.</p>

    <div class="controls">
      <button id="startScanBtn" class="primary">üì∑ Scan QR Code</button>
      <button id="stopScanBtn" class="ghost" style="display:none">‚úï Stop Scanner</button>
    </div>

    <div id="reader" aria-hidden="true"></div>

    <form id="verifyForm" autocomplete="off">
      <label for="qualificationNumber" class="small">Qualification Number</label>
      <input type="text" id="qualificationNumber" placeholder="e.g. UKQ-001-A" />

      <label for="name" class="small" style="margin-top:.5rem">Candidate Name</label>
      <input type="text" id="name" placeholder="e.g. Benjamin Wayne" />

      <button type="submit" class="primary" style="margin-top:1rem">Verify Certificate</button>
    </form>

    <div id="loadingMessage" style="display:none;margin-top:.75rem">Checking...</div>
    <div id="result" aria-live="polite"></div>

    <div class="info-small">Provider: Newcastle College Ltd | UKPRN: 10093850. Listed on UKRLP. Regulated by OFQUAL.</div>

    <div id="admin-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:.25rem 0">üîí Admin Panel</h3>
        <div class="flex">
          <button id="refreshListBtn" class="ghost">üîÑ Refresh</button>
        </div>
      </div>

      <div style="margin-top:.5rem;overflow:auto;max-height:300px">
        <table id="certTable"><thead><tr><th>QualificationNumber</th><th>Name</th><th>Level</th><th>AwardedBy</th><th>Year</th><th>Actions</th></tr></thead><tbody></tbody></table>
      </div>

      <div style="margin-top:1rem">
        <h4 style="margin:.25rem 0">Add New Certificate</h4>
        <form id="addCertForm">
          <input name="QualificationNumber" placeholder="Qualification Number" required style="margin-top:.5rem" />
          <input name="Name" placeholder="Name" required style="margin-top:.5rem" />
          <input name="Level" placeholder="Level" style="margin-top:.5rem" />
          <input name="AwardedBy" placeholder="Awarded By" style="margin-top:.5rem" />
          <input name="Year" placeholder="Year" style="margin-top:.5rem" />
          <div style="display:flex;gap:.5rem;margin-top:.75rem">
            <button type="submit" class="primary">Add & Generate QR</button>
            <button type="button" id="hideAdmin" class="ghost">Close</button>
          </div>
        </form>
        <div id="qrCodeContainer" class="qr-preview" style="margin-top:.75rem"></div>
      </div>
    </div>
  </main>

  <footer>GOV.UK Verified | ¬© Newcastle College Ltd</footer>

  <script>
    // CONFIG ‚Äî change ADMIN_PASSWORD if you like
    const ADMIN_PASSWORD = 'sex126';
    const BACKEND_LIST_ADD = 'https://script.google.com/macros/s/AKfycbx7JBVUAuaqmBVSuLPFJF0b0roc2-J9TGBT7WvepXHonW_8K0_k_qkHRcABeAqmD1YJhg/exec';
    const BACKEND_DELETE = 'https://script.google.com/macros/s/AKfycbyKMPnASKojj0TNZwEkUp8uzevIkLIPtZ7acUaDEVnh7xdc-PC0ei48pvkg_RALsU2-LQ/exec';

    // UI refs
    const readerDiv = document.getElementById('reader');
    const startScanBtn = document.getElementById('startScanBtn');
    const stopScanBtn = document.getElementById('stopScanBtn');
    const loading = document.getElementById('loadingMessage');
    const resultDiv = document.getElementById('result');

    // scanner instance
    let scannerInstance = null;

    // helpers
    const escapeHtml = (s='') => String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const textEqual = (a,b) => String(a||'').trim().toLowerCase() === String(b||'').trim().toLowerCase();

    // renderers
    function renderVerified(rec){
      resultDiv.innerHTML = `
        <div class="verified">
          ‚úÖ <strong>VERIFIED</strong><br>
          <b>Name:</b> ${escapeHtml(rec.Name)}<br>
          <b>Qualification:</b> ${escapeHtml(rec.QualificationNumber)}<br>
          <b>Level:</b> ${escapeHtml(rec.Level||'')}<br>
          <b>Awarded By:</b> ${escapeHtml(rec.AwardedBy||'')}<br>
          <b>Year:</b> ${escapeHtml(rec.Year||'')}
        </div>`;
    }
    function renderNotFound(){
      resultDiv.innerHTML = `<div class="not-found">‚ùå <strong>NOT FOUND</strong><br>The qualification number or candidate name appears invalid or unregistered.</div>`;
    }

    // VERIFY: fetch list and check locally
    async function verifyQualification(e){
      if(e && e.preventDefault) e.preventDefault();
      const qual = document.getElementById('qualificationNumber').value.trim();
      const name = document.getElementById('name').value.trim();
      if(!qual || !name) return;
      loading.style.display = 'block';
      resultDiv.innerHTML = '';
      try {
        const res = await fetch(BACKEND_LIST_ADD, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'list' })
        });
        const data = await res.json();
        loading.style.display = 'none';
        if(data && Array.isArray(data.records)){
          const found = data.records.find(r => textEqual(r.QualificationNumber, qual) && textEqual(r.Name, name));
          if(found) { renderVerified(found); return; }
        }
        renderNotFound();
      } catch(err){
        loading.style.display = 'none';
        resultDiv.innerHTML = `<div class="not-found">‚ùå Unable to verify at this time. (${escapeHtml(err.message || err)})</div>`;
      }
    }

    document.getElementById('verifyForm').addEventListener('submit', verifyQualification);

    // SCANNER
    async function startScanner(){
      startScanBtn.disabled = true;
      stopScanBtn.style.display = 'inline-block';
      readerDiv.style.display = 'block';
      if(scannerInstance) return;
      scannerInstance = new Html5Qrcode('reader');
      try {
        await scannerInstance.start(
          { facingMode: 'environment' },
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        );
      } catch(err){
        resultDiv.innerHTML = `<div class="not-found">Camera error: ${escapeHtml(err.message || err)}</div>`;
        stopScanner();
      }
    }

    function onScanSuccess(decodedText){
      // support JSON payload or pipe-delimited "QUAL|NAME"
      let qual = '', fullName = '';
      try {
        const t = decodedText.trim();
        if(t.startsWith('{')){ const obj = JSON.parse(t); qual = obj.qualificationNumber||obj.QualificationNumber||''; fullName = obj.name||obj.Name||''; }
        else { const parts = decodedText.split('|'); qual = parts[0]||''; fullName = parts.slice(1).join('|')||''; }
      } catch(e){
        const parts = decodedText.split('|'); qual = parts[0]||''; fullName = parts.slice(1).join('|')||'';
      }
      if(qual && fullName){
        document.getElementById('qualificationNumber').value = qual;
        document.getElementById('name').value = fullName;
        verifyQualification();
        stopScanner();
      }
    }

    function onScanFailure(error){ /* ignored */ }

    function stopScanner(){
      if(!scannerInstance){
        readerDiv.style.display='none'; stopScanBtn.style.display='none'; startScanBtn.disabled=false; return;
      }
      scannerInstance.stop().then(()=>{
        scannerInstance.clear();
        scannerInstance = null;
        readerDiv.style.display='none';
        stopScanBtn.style.display='none';
        startScanBtn.disabled=false;
      }).catch(()=>{
        scannerInstance = null;
        readerDiv.style.display='none';
        stopScanBtn.style.display='none';
        startScanBtn.disabled=false;
      });
    }

    stopScanBtn.addEventListener('click', stopScanner);
    startScanBtn.addEventListener('click', startScanner);

    // ADMIN: toggle via Ctrl+Shift+A
    document.addEventListener('keydown', async (e)=>{
      if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a'){
        e.preventDefault();
        const panel = document.getElementById('admin-panel');
        if(panel.style.display === 'block'){ panel.style.display='none'; return; }
        const pass = prompt('Enter admin password:');
        if(pass === ADMIN_PASSWORD){ panel.style.display='block'; await fetchCertificates(); }
        else alert('Incorrect password');
      }
    });

    // ADMIN: fetch
    async function fetchCertificates(){
      const tbody = document.querySelector('#certTable tbody');
      tbody.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
      try {
        const res = await fetch(BACKEND_LIST_ADD, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'list' })
        });
        const data = await res.json();
        if(data && Array.isArray(data.records) && data.records.length > 0){
          tbody.innerHTML = '';
          data.records.forEach(r=>{
            const q = escapeHtml(r.QualificationNumber||'');
            const n = escapeHtml(r.Name||'');
            const l = escapeHtml(r.Level||'');
            const a = escapeHtml(r.AwardedBy||'');
            const y = escapeHtml(r.Year||'');
            const row = document.createElement('tr');
            row.innerHTML = `<td>${q}</td><td>${n}</td><td>${l}</td><td>${a}</td><td>${y}</td>
              <td>
                <div class="flex">
                  <button type="button" style="background:#fff;border:1px solid #f3f8ff;padding:.25rem .5rem;border-radius:6px;color:#c62828" onclick="deleteCertificate('${q.replace(/'/g,\"\\\\'\")}','${n.replace(/'/g,\"\\\\'\")}')">üóëÔ∏è</button>
                  <button type="button" style="background:#fff;border:1px solid #f3f8ff;padding:.25rem .5rem;border-radius:6px;color:var(--brand);margin-left:.4rem" onclick="generateQRCode('${q.replace(/'/g,\"\\\\'\")}','${n.replace(/'/g,\"\\\\'\")}')">üì• QR</button>
                </div>
              </td>`;
            tbody.appendChild(row);
          });
          return;
        }
        tbody.innerHTML = '<tr><td colspan="6">No records found.</td></tr>';
      } catch(err){
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6">Error loading records.</td></tr>';
      }
    }

    document.getElementById('refreshListBtn').addEventListener('click', fetchCertificates);
    document.getElementById('hideAdmin').addEventListener('click', ()=> { document.getElementById('admin-panel').style.display = 'none'; });

    // ADMIN: add
    document.getElementById('addCertForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = { action: 'add' };
      fd.forEach((v,k) => payload[k] = String(v||'').trim());
      try {
        const res = await fetch(BACKEND_LIST_ADD, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data && data.success){
          alert('Certificate added');
          generateQRCode(payload.QualificationNumber, payload.Name);
          e.target.reset();
          fetchCertificates();
        } else {
          alert('Add failed: ' + (data && data.error || 'unknown'));
        }
      } catch(err){
        console.error(err);
        alert('Error adding certificate');
      }
    });

    // ADMIN: delete
    async function deleteCertificate(q, n){
      if(!confirm(`Delete ${n} (${q})?`)) return;
      try {
        const res = await fetch(BACKEND_DELETE, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'delete', QualificationNumber: q, Name: n })
        });
        const data = await res.json();
        if(data && data.success){ alert('Deleted'); fetchCertificates(); }
        else alert('Delete failed: ' + (data && data.error || 'unknown'));
      } catch(err){
        console.error(err);
        alert('Error deleting certificate');
      }
    }

    // QR generation + download
    function generateQRCode(id, name){
      const text = `${id}|${name}`;
      const container = document.getElementById('qrCodeContainer');
      container.innerHTML = '';
      QRCode.toDataURL(text, { width: 300, margin: 2 }).then(url => {
        container.innerHTML = `<div class="flex"><div class="qr-preview"><img src="${url}" alt="QR"/></div>
          <div style="margin-left:12px"><a class="primary-download" href="${url}" download="certificate_qr_${encodeURIComponent(id)}.png">Download PNG</a></div></div>`;
      }).catch(err => {
        console.error(err);
        container.textContent = 'Error generating QR code';
      });
    }
  </script>
</body>
</html>
